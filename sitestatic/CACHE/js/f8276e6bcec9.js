$(document).ready(function(){prepareOmnibox();});function omnibox(ele,types,options){if(ele.data('select2')){return;}
var data=[];if(options===undefined){options={}}
if(options.variables){for(var idx in options.variables){var v='@'+options.variables[idx].name.toLowerCase();data.push({id:v,text:v+" - "+options.variables[idx].display})}}
if(types===undefined){types='cg';}
var placeholder=null;if(types=='g'){placeholder=gettext("Enter one or more contact groups");}else if(types=='c'){placeholder=gettext("Recipients, enter contacts");}else if(types=='cu'){placeholder=gettext("Recipients, enter contacts or phone numbers");}
else{placeholder=gettext("Recipients, enter contacts or groups");}
ele.attr('placeholder',placeholder);var q='';if(!options.createSearchChoice&&types.indexOf('u')>=0){options.createSearchChoice=arbitraryNumberOption;}
var multiple=true;if(options.multiple!=undefined){multiple=options.multiple;}
return ele.removeClass("loading").select2({placeholder:placeholder,data:data,allowClear:false,selectOnBlur:false,minimumInputLength:0,multiple:multiple,initSelection:function(element,callback){var initial=$(element).val();element.select2('data',[]);if(initial){initial=eval(initial);callback(initial);}},createSearchChoice:options.createSearchChoice,ajax:{url:"/contact/omnibox/?types="+types,dataType:'json',data:function(term,page,context){q=term;return{search:term,page:page};},results:function(response,page,context){if(data){if(q){q=q.toLowerCase();if(q.indexOf('@')==0){for(var idx in data){var variable=data[idx];if(variable.id.indexOf(q)==0){response.results.unshift(variable);}}}}}
return response;}},escapeMarkup:function(m){return m;},containerCssClass:"omnibox-select2",formatSelection:formatOmniboxSelection,formatResult:formatOmniboxOption});}
function prepareOmnibox(types){if(types===undefined){types='cg';}
omnibox($(".omni_widget"),types);}
function initializeOmnibox(initial){var options={placeholder:gettext("Recipients, enter contacts or phone numbers"),minimumInputLength:0,multiple:true,ajax:{url:"/contact/omnibox/?types=cu",dataType:'json',data:function(term,page){return{search:term,page:page};},results:function(data,page){return data;}},escapeMarkup:function(m){return m;},containerCssClass:"omnibox-select2",formatSelection:formatOmniboxSelection,formatResult:formatOmniboxOption,createSearchChoice:arbitraryNumberOption};var omnibox=$("#omnibox").removeClass("loading").select2(options);if(initial){$("#omnibox").select2('data',initial);$("#omni-select2").show();$("#loading").hide();$("#send-message .ok").text(gettext("Send Message")).removeClass("disabled");}
else{$("#omnibox").select2('data',null);}}
function arbitraryNumberOption(term,data){if(anon_org){return null;}
if($(data).filter(function(){return this.text.localeCompare(term)===0;}).length===0){if(!isNaN(parseFloat(term))&&isFinite(term)){return{id:"n-"+term,text:term};}}}
function formatOmniboxSelection(item){if(item.length==0){return"";}
return formatOmniboxItem(item);}
function formatOmniboxOption(item,container,query){if(query.term[0]=="+"){query.term=query.term.substring(1,query.length);}
return formatOmniboxItem(item);}
function formatOmniboxItem(item){var text=(item.extra!=null)?(item.text+" ("+item.extra+")"):item.text;var clazz='';if(item.id.indexOf("g-")==0){clazz='omni-group';}else if(item.id.indexOf("c-")==0){clazz='omni-contact';}else if(item.id.indexOf("u-")==0){if(item.scheme=='tel'){clazz='omni-tel';}else if(item.scheme=='twitter'){clazz='omni-twitter';}else if(item.scheme=='telegram'){clazz='omni-telegram';}}
return'<div class="omni-option '+clazz+'">'+text+'</div>';}
if(typeof console=="undefined"){this.console={log:function(msg){}};}
function getCookie(name){var cookieValue=null;if(document.cookie&&document.cookie!=''){var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
var csrftoken=getCookie('csrftoken');function csrfSafeMethod(method){return(/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));}
$.ajaxSetup({crossDomain:false,beforeSend:function(xhr,settings){if(!csrfSafeMethod(settings.type)){xhr.setRequestHeader("X-CSRFToken",csrftoken);}}});$(document).ready(function(){$('iframe').each(function(){var url=$(this).attr("src");if(url.indexOf("youtube.com")>=0){if(url.indexOf("?")>=0){$(this).attr("src",url+"&wmode=transparent");}else{$(this).attr("src",url+"?wmode=transparent");}}});$('ul.nav li.dropdown').hover(function(){$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeIn();},function(){$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeOut();});$(".pollrun-select-btn").on('click',pollRunSelectHandle);});function pollRunSelect(pollRunId){$("input#pollrun").val(pollRunId);$("form[name=pollrun]").submit();}
function pollRunSelectHandle(){pollRunSelect($(this).data('id'));$("#pollrun-text > span.text").text($(this).text());}
function getCheckedIds(){return Array();}
bindRefreshBlock();function bindRefreshBlock(){$('[data-toggle=dropdown]').on('focus',function(){dropDownOpen=true;hideTooltip();checkBlockRefresh();});$('[data-toggle=dropdown]').on('blur',function(){dropDownOpen=false;hideTooltip();checkBlockRefresh();});}
var dropDownOpen=false;var rowsChecked=getCheckedIds().length>0;function checkBlockRefresh(){$("#pjax").data('no-pjax',(dropDownOpen||rowsChecked));}
function getStartTime(){if($("#later-option").attr("checked")){return moment(new Date($("#start-datetime-value").val()*1000));}else{return moment();}}
function getStartHour(){var time=getStartTime();var hour=time.getHours();if(hour>12){hour=hour-12+"pm";}else{hour+="am";}
return hour;}
function update_schedule(){}
function updateDailySelection(){var selected=0;$('.btn-group > .btn').each(function(){if($(this).hasClass('active')){selected+=parseInt($(this).attr("value"));}});$("#repeat-days-value").val(selected);}
function scheduleSelection(event){event.stopPropagation();if($(this).attr('data-toggle')!='button'){$(this).toggleClass('active');}
var selected=$('.btn-group > .btn.active').length;if(selected==0&&!$(this).hasClass('active')){$(this).toggleClass('active');}
updateDailySelection();}
function hideTooltip(){$(".tooltip").fadeOut();}
function updateFile(){var file=$("#csv_file").val();while(file.indexOf("\\")>=0){file=file.substring(file.indexOf("\\")+1,file.length);}
$("#file-field").val(file);}
function intersect(a,b){var ai=0,bi=0;var result=new Array();while(ai<a.length&&bi<b.length){if(a[ai]<b[bi]){ai++;}else if(a[ai]>b[bi]){bi++;}else{result.push(a[ai]);ai++;bi++;}}
return result;}
function numericComparator(a,b){return a-b;}
function messageTextareaLengthCheck(){var length=$(this).val().length;var messages=Math.ceil(length/160);var left=messages*160-length;if(messages<2){$("#counter").text(""+left);}else{$("#counter").text(""+left+" / "+messages);}}
function initMessageLengthCounter(textarea,counter){function onKeyUp(){var ta=$(textarea);if(ta){var val=ta.val()
var length=0;if(val){length=val.length;}
var messages=Math.ceil(length/160);var left=messages*160-length;if(length==0){$(counter).text(""+160);}else if(messages<2){$(counter).text(""+left);}else{$(counter).text(""+left+" / "+messages);}}}
$(textarea).live('keyup',onKeyUp);onKeyUp();}
function toggle_section(){var shrink;$(".form-section").each(function(){var visible=$(this);if(visible.find('.expanded').is(":visible")){hide_section(visible);shrink=visible;}});var row=$(this).parent('.form-section');if(!shrink||(shrink&&row.attr("id")!=shrink.attr("id"))){var expanded=row.find('.expanded');if(expanded.is(":visible")){hide_section(row);}else{expand_section(row);}}}
function hide_section(section){if(!section.hasClass("error")){section.addClass('expandable');}
try{eval("update_"+section.attr("id")+"()");}catch(e){}
section.find('.section-icon').animate({'font-size':'35px','width':'40px','height':'40px'},200,function(){});section.find('.expanded').hide();section.find('.summary').fadeIn('slow');}
function expand_section(section){section.removeClass('expandable');section.find('.section-icon').animate({'font-size':'80px','width':'100px','height':'100px'},200,function(){});section.find('.expanded').slideDown('fast');section.find('.summary').hide();}
function setDatetimeValue(datetimeText,datepickerInstance,nextStart){var datetime=null;if(nextStart){datetime=nextStart;}else{datetime=new Date(datetimeText.replace(" at",""));}
var seconds=parseInt(datetime.getTime()/1000);$('#start-datetime-value').val(seconds);update_schedule();}
function resetStartDatetime(){var datetime=$("#start-datetime");if(datetime.val()=="Later"){datetime.val("");}datetime.focus();}
function startDatetimeClick(){$("#later-option").click();}
function initializeVideoPlayer(element){videojs(element,{plugins:{vjsdownload:{beforeElement:'playbackRateMenuButton',textControl:'Download',name:'downloadButton'}}});}
function disposeVideoPlayer(element){var player=videojs.getPlayers()[element.playerId];if(player){player.dispose();}}
(function(excellent){var STATE_BODY=0;var STATE_PREFIX=1;var STATE_IDENTIFIER=2;var STATE_BALANCED=3;var STATE_STRING_LITERAL=4;var STATE_ESCAPED_PREFIX=5;var STATE_IGNORE=6;excellent.Parser=function(expressionPrefix,allowedTopLevels){this.expressionPrefix=expressionPrefix;this.allowedTopLevels=allowedTopLevels;};excellent.Parser.prototype.expressionContext=function(textToCaret){expressions=this.expressions(textToCaret);if(expressions.length==0){return null;}
var lastExpression=expressions[expressions.length-1];if(lastExpression.end<textToCaret.length||lastExpression.closed){return null;}
return lastExpression.text.substring(1);};excellent.Parser.prototype.autoCompleteContext=function(partialExpression){if(this.isInStringLiteral(partialExpression)){return null;}
var fragment="";var skipChar=false;var neededParentheses=[];var inQuotes=false;var prependFlag='';for(var pos=partialExpression.length-1;pos>=0;pos--){var ch=partialExpression[pos];if(ch===' '){skipChar=true;}
if(ch===','){skipChar=true;if(neededParentheses[neededParentheses.length-1]!='('){neededParentheses.push('(');}}
if(ch===')'&&!inQuotes){skipChar=true;neededParentheses.push('(');neededParentheses.push('(');}
if(ch==='"'){inQuotes=!inQuotes;}
if(skipChar){if(ch==='('&&!inQuotes){if(neededParentheses[neededParentheses.length-1]=='('){neededParentheses.pop();}
if(neededParentheses.length==0){skipChar=false;}}}
if(ch==='('&&fragment==''){prependFlag='#';}
if(skipChar||inQuotes||(ch==='('&&fragment=='')){continue;}
if(isWordChar(ch)||ch==='.'){fragment=ch+fragment;}else{break;}}
if(fragment.match(/[A-Za-z][\w]*(\.[\w]+)*/)){return prependFlag+fragment;}
else{return null;}};excellent.Parser.prototype.isInStringLiteral=function(partialExpression){var num_quotes=0;for(var pos=0;pos<partialExpression.length;pos++){if(partialExpression[pos]==='"'){num_quotes++;}}
return num_quotes%2!=0;};excellent.Parser.prototype.functionContext=function(partialExpression){var inString=this.isInStringLiteral(partialExpression);var state=inString?STATE_IGNORE:STATE_STRING_LITERAL;var identifier="";var parenthesesLevel=0;for(var pos=partialExpression.length-1;pos>=0;pos--){var ch=partialExpression[pos];if(state==STATE_IGNORE){if(parenthesesLevel==0&&(isWordChar(ch)||ch==='.')){state=STATE_IDENTIFIER;identifier=ch+identifier;}
else if(ch=="\""){state=STATE_STRING_LITERAL;}
else if(ch==='('){parenthesesLevel--;}
else if(ch===')'){parenthesesLevel++;}}
else if(state==STATE_IDENTIFIER){if(isWordChar(ch)||ch==='.'){identifier=ch+identifier;}
else{return identifier;}}
else if(state==STATE_STRING_LITERAL){if(ch=="\""){state=STATE_IGNORE;}}}
return null;};excellent.Parser.prototype.getContactFields=function(text){var fields={};var re=/(parent|child\.)*contact\.([a-z0-9_]+)/g;var expressions=this.expressions(text);for(var i=0;i<expressions.length;i++){var match;while(match=re.exec(expressions[i].text)){fields[match[2]]=true;}}
return Object.keys(fields);}
excellent.Parser.prototype.expressions=function(text){var expressions=[];var state=STATE_BODY;var currentExpression=null;var parenthesesLevel=0;for(var pos=0;pos<text.length;pos++){var ch=text[pos];var nextCh=(pos<(text.length-1))?text[pos+1]:0;var nextNextCh=(pos<(text.length-2))?text[pos+2]:0;if(state==STATE_BODY){if(ch==this.expressionPrefix&&(isWordChar(nextCh)||nextCh=='(')){state=STATE_PREFIX;currentExpression={start:pos,end:null,text:ch};}else if(ch==this.expressionPrefix&&nextCh==this.expressionPrefix){state=STATE_ESCAPED_PREFIX;}}
else if(state==STATE_PREFIX){if(isWordChar(ch)){state=STATE_IDENTIFIER;}else if(ch=='('){state=STATE_BALANCED;parenthesesLevel+=1;}
currentExpression.text+=ch;}
else if(state==STATE_IDENTIFIER){currentExpression.text+=ch;}
else if(state==STATE_BALANCED){if(ch=='('){parenthesesLevel+=1;}else if(ch==')'){parenthesesLevel-=1;}else if(ch=='"'){state=STATE_STRING_LITERAL;}
currentExpression.text+=ch;if(parenthesesLevel==0){currentExpression.end=pos+1;}}
else if(state==STATE_STRING_LITERAL){if(ch=='"'){state=STATE_BALANCED;}
currentExpression.text+=ch;}
else if(state==STATE_ESCAPED_PREFIX){state=STATE_BODY;}
if(state==STATE_IDENTIFIER){if((!isWordChar(nextCh)&&nextCh!=='.')||(nextCh==='.'&&!isWordChar(nextNextCh))){currentExpression.end=pos+1;}}
if(currentExpression!=null&&(currentExpression.end!=null||nextCh===0)){var allowIncomplete=(nextCh===0);if(isValidStart(currentExpression.text,this.allowedTopLevels,allowIncomplete)){currentExpression.closed=(currentExpression.text[1]==='(')&&(parenthesesLevel==0);currentExpression.end=pos+1;expressions.push(currentExpression);}
currentExpression=null;state=STATE_BODY;}}
return expressions;};function isValidStart(partialExpression,allowedTopLevels,allowIncomplete){var body=partialExpression.substring(1);if(body[0]==='('){return true;}else{var topLevel=body.split('.')[0].toLowerCase();if(allowIncomplete){for(var n=0;n<allowedTopLevels.length;n++){if(startsWith(allowedTopLevels[n],topLevel)){return true;}}}else{return allowedTopLevels.indexOf(topLevel)>=0;}
return false;}}
function startsWith(str,start){return str.indexOf(start,0)===0;}
function isWordChar(ch){return(ch>='a'&&ch<='z')||(ch>='A'&&ch<='Z')||(ch>='0'&&ch<='9')||ch=='_';}}(window.excellent=window.excellent||{}));function getCheckedIds(){var checkedIds=Array();var checks=$(".object-row.checked");for(var i=0;i<checks.length;i++){checkedIds.push(parseInt($(checks[i]).data("object-id")));}
rowsChecked=checkedIds.length>0;checkBlockRefresh();return checkedIds.sort(numericComparator);}
function getCheckedUuids(){var checkedUuids=Array();var checks=$(".object-row.checked");for(var i=0;i<checks.length;i++){checkedUuids.push($(checks[i]).data("uuid"));}
rowsChecked=checkedUuids.length>0;checkBlockRefresh();return checkedUuids.sort();}
function getLabeledIds(labelId){var objectRowsIds=Array();var labeled=$(".lbl[data-id='"+labelId+"']");for(var i=0;i<labeled.length;i++){var id=parseInt($(labeled[i]).parents(".object-row").data("object-id"))
objectRowsIds.push(id);}
return objectRowsIds.sort(numericComparator);}
function getObjectRowLabels(objectId){var labelIds=Array();var labels=$(".object-row[data-object-id='"+objectId+"']").find(".lbl");for(var i=0;i<labels.length;i++){labelIds.push(parseInt($(labels[i]).data("id")));}
return labelIds.sort(numericComparator);}
function runActionOnObjectRows(action){var objectIds=getCheckedIds();jQuery.ajaxSettings.traditional=true;fetchPJAXContent("","#pjax",{postData:{objects:objectIds,action:action,pjax:'true'},forceReload:true});}
function unlabelObjectRows(labelId){var objectsIds=getCheckedIds();var addLabel=false;jQuery.ajaxSettings.traditional=true;fetchPJAXContent("","#pjax",{postData:{objects:objectsIds,label:labelId,add:addLabel,action:'unlabel',pjax:'true'},forceReload:true});}
function labelObjectRows(labelId){labelObjectRows(labelId,false)}
function labelObjectRows(labelId,forceRemove){var objectRowsIds=getCheckedIds();var labeledIds=getLabeledIds(labelId);var addLabel=false;for(var i=0;i<objectRowsIds.length;i++){var found=false;for(var j=0;j<labeledIds.length;j++){if(objectRowsIds[i]==labeledIds[j]){found=true;break;}}
if(!found){addLabel=true;break;}}
var checkbox=$('.lbl-menu[data-id="'+labelId+'"] .glyph');if(checkbox.hasClass("checked-child")){addLabel=true;}
if(checkbox.hasClass("checked")){addLabel=false;}
if(forceRemove){addLabel=false;}
jQuery.ajaxSettings.traditional=true;lastChecked=getCheckedIds();if(objectRowsIds.length==0){showWarning('{% trans "No rows selected" %}','{% trans "Please select one or more rows before continuing." %}');return;}
postLabelChanges(objectRowsIds,labelId,addLabel);}
function recheckIds(){if(lastChecked&&lastChecked.length>0){for(var i=0;i<lastChecked.length;i++){$(".object-row[data-object-id='"+lastChecked[i]+"']").addClass('checked');}
$(".search-details").hide();$(".list-buttons-container").addClass('visible');updateLabelMenu();}
else{$(".search-details").show();$(".list-buttons-container").removeClass('visible');}}
function clearLabelMenu(){$('.lbl-menu .glyph').removeClass('checked').removeClass('partial').removeClass('checked-child');}
function updateLabelMenu(){clearLabelMenu();var objectRowsIds=getCheckedIds();var updatedLabels=Object()
for(var i=0;i<objectRowsIds.length;i++){var labelIds=getObjectRowLabels(objectRowsIds[i]);for(var j=0;j<labelIds.length;j++){var labelId=labelIds[j];if(!updatedLabels[labelId]){var labeledIds=getLabeledIds(labelId);var objectRowIdsWithLabel=intersect(objectRowsIds,labeledIds);var label=$('.lbl-menu[data-id="'+labelId+'"] .glyph');if(objectRowIdsWithLabel.length==objectRowsIds.length){label.addClass("checked");label.removeClass("partial");var parentLabel=$($('.lbl-menu[data-id="'+labelId+'"]').parents('.dropdown-submenu').find('.lbl-menu')[0]);if(parentLabel){var parentBox=$(parentLabel.children(".glyph")[0]);if(!parentBox.hasClass('checked')){parentBox.addClass('checked-child');}}}else{label.addClass("partial");var parentLabel=$($('.lbl-menu[data-id="'+labelId+'"]').parents('.dropdown-submenu').find('.lbl-menu')[0]);if(parentLabel){var parentBox=$(parentLabel.children(".glyph")[0]);if(!parentBox.hasClass('checked')){parentBox.addClass('checked-child');}}}
updatedLabels[labelId]=true;}}}}
$(document).on('click','td.object-row-checkbox',function(e){e.stopPropagation();e.preventDefault();$(".list-buttons-container").addClass('visible');var row=$(this).parent('tr');if(row.hasClass("checked")){row.removeClass("checked");var checks=$(".object-row.checked");if(checks.length==0){$('.list-buttons-container').removeClass('visible');}}else{row.addClass("checked");}
updateLabelMenu();return false;});$(document).ready(function(){$(".page-content").on('click',".object-btn-label",function(){labelObjectRows($(this).data('id'));});if($('.object-btn-unlabel').length>0){if(current_label_id){$(".page-content").on('click',".object-btn-unlabel",function(){labelObjectRows(current_label_id,true);});}}
$(".page-content").on('click',".object-btn-restore",function(){runActionOnObjectRows("restore");});$(".page-content").on('click',".object-btn-archive",function(){runActionOnObjectRows("archive");});$(".page-content").on('click',".object-btn-delete",function(){runActionOnObjectRows("delete");});$(".page-content").on('click',".object-btn-resend",function(){runActionOnObjectRows("resend");});$(".page-content").on('click',".object-btn-send-notification",function(){runActionOnObjectRows("send-notification");});});(function(){var ENTER,TAB,filters,findMatches,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;if(String.prototype.trim==null){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}
if(String.prototype.rtrim==null){String.prototype.rtrim=function(){return this.replace(/^\s+/,"");};}
if(String.prototype.ltrim==null){String.prototype.ltrim=function(){return this.replace(/\s+$/,"");};}
if(String.prototype.strip==null){String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"");};}
TAB=9;ENTER=13;filters=[{name:'title_case',display:'changes to title case'},{name:'capitalize',display:'capitalizes the first letter'},{name:'first_word',display:'takes only the first word'},{name:'remove_first_word',display:'takes everything after the first word'},{name:'upper_case',display:'upper cases all letters'},{name:'lower_case',display:'lower cases all letters'},{name:'read_digits',display:'reads back a number in a friendly way'}];findMatches=function(query,data,start,lastIdx,prependChar){var display,i,len,matched,name,nextDot,option,results,suffix;if(prependChar==null){prependChar=void 0;}
matched={};results=[];for(i=0,len=data.length;i<len;i++){option=data[i];if(option.name.indexOf(query)===0){nextDot=option.name.indexOf('.',lastIdx+1);if(nextDot===-1){if(prependChar){name=start+prependChar+option.name;}else{name=option.name;}
display=option.display;}else{name="";suffix=option.name.substring(lastIdx+1,nextDot);if(start.length>0&&start!==suffix){name=start+".";}
name+=suffix;if(name.indexOf(query)!==0){continue;}
display=null;}
if(!(name in matched)){matched[name]=name;results.push({name:name,display:display});}}}
return results;};this.useFontCheckbox=function(selector,displayLabel){var checkboxes;if(displayLabel==null){displayLabel=false;}
checkboxes=$(selector);return checkboxes.each(function(){var chkBox,controlGroup,ele,glyphCheck,help,helpText,html,input,label;input=$(this);controlGroup=input.parents('.control-group');label=controlGroup.children("label").text();help=input.parent().children(".help-block");html="<div class='form-group font-checkbox'>";html+="<label";if(!displayLabel){html+=" id='checkbox-label'";}
html+=" class='control-label' for='";html+=input.prop('id');html+="'>";html+=label;html+="</label>";html+="<div class='controls field-input";if(input.prop('checked')){html+=" checked";}
html+="'>";html+="<div class='hidden-input hide'>";html+="<input name='"+input.prop('name')+"' id='"+input.prop('id')+"' type='"+input.prop('type')+"' ";if(input.prop('checked')){html+=" checked";}
html+="/>";html+="</div>";html+="<div class='glyph notif-checkbox'></div><div></div>";if(help){if(!displayLabel){html+="<div class='help-block'><label for='";html+=input.prop('id');html+="'>"+help.text()+"</label></div>";}else{html+="<p class='help-block'>"+help.text()+"</p>";}}
html+="</div></div>";ele=$(html);controlGroup.replaceWith(ele);helpText=ele.children('.controls').children('.help-block').children('label');helpText.on('click',function(event){$(this).parent().parent('.field-input').children('.glyph.notif-checkbox').click();return event.preventDefault();});glyphCheck=ele.children('.controls').children('.glyph.notif-checkbox');glyphCheck.on('click',function(){var cell,ipt;cell=$(this).parent('.field-input');ipt=cell.children().children("input[type='checkbox']");if(ipt.prop('checked')){cell.removeClass('checked');return ipt.prop('checked',false);}else{cell.addClass('checked');return ipt.prop('checked',true);}});chkBox=ele.find("input[type=checkbox]");return chkBox.on('change',function(){var cell;cell=ele.find('.field-input');if($(this).prop('checked')){return cell.addClass('checked');}else{return cell.removeClass('checked');}});});};this.select2div=function(selector,width,placeholder,add_prefix){var child,children,ele,i,len,option,options,selected;if(width==null){width="350px";}
if(placeholder==null){placeholder=null;}
if(add_prefix==null){add_prefix=null;}
ele=$(selector);children=ele.children('option');options=[];selected=null;for(i=0,len=children.length;i<len;i++){child=children[i];option={id:child.value,text:child.label};if(child.selected){selected=option;}
options.push(option);}
ele.replaceWith("<input width='"+width+"' name='"+ele.attr('name')+"' style='width:"+width+"' id='"+ele.attr('id')+"'/>");ele=$(selector);if(add_prefix){ele.select2({name:name,data:options,placeholder:placeholder,query:function(query){var cleaned_query,d,data,exact_match,j,len1,ref;data={results:[]};cleaned_query=query.term.toLowerCase().strip();exact_match=false;ref=this['data'];for(j=0,len1=ref.length;j<len1;j++){d=ref[j];if(d.text.toLowerCase().indexOf(cleaned_query)!==-1){data.results.push({id:d.id,text:d.text});if(d.text.toLowerCase()===cleaned_query){exact_match=true;}}}
if(!exact_match&&cleaned_query.length>0){data.results.push({id:'[_NEW_]'+query.term,text:add_prefix+query.term});}
return query.callback(data);},createSearchChoice:function(term,data){return data;}});}else{ele.select2({minimumResultsForSearch:99,data:options,placeholder:placeholder});}
if(selected){return ele.data('select2').data(selected);}};this.select2field=function(ele){var id,placeholder,select2,url;url=ele.attr('url');placeholder=ele.attr('placeholder');select2=ele.removeClass("loading").select2({placeholder:placeholder,allowClear:false,selectOnBlur:false,minimumInputLength:0,multiple:false,initSelection:function(ele,callback){var id,text;id=ele.val();text=ele.attr('text');return callback({id:id,text:text});},ajax:{url:url,dataType:"json",data:function(term,page,context){var q;q=term;return{search:term,page:page};},results:function(response,page,context){return response;}}});id=ele.val();return $(ele).select2('val',id,true);};this.formatNumber=function(number){return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");};this.Modal=(function(){function Modal(title1,message1){var modal,modalClose;this.title=title1;this.message=message1;modal=this;this.autoDismiss=true;this.ele=$('#modal-template').clone();this.ele.data('object',this);this.ele.attr('id','active-modal');this.keyboard=false;modalClose=this.ele.find('.close');modalClose.on('click',function(){return modal.dismiss();});}
Modal.prototype.setIcon=function(icon){this.icon=icon;return this.ele.find('.icon').addClass('glyph').addClass(this.icon);};Modal.prototype.setPrimaryButton=function(buttonName){var primary;if(buttonName==null){buttonName=gettext('Ok');}
primary=this.ele.find('.primary');return primary.text(buttonName);};Modal.prototype.setTertiaryButton=function(buttonName,handler){var tertiary;if(buttonName==null){buttonName='Options';}
tertiary=this.ele.find('.tertiary');tertiary.text(buttonName);tertiary.on('click',handler);return tertiary.show();};Modal.prototype.show=function(){var modal;modal=this;this.ele.on('hidden',function(){if(modal.listeners&&modal.listeners.onDismiss){return modal.listeners.onDismiss(modal);}});this.ele.find('#modal-title').html(this.title);if(this.message){this.ele.find('#modal-message').html(this.message);}else{this.ele.find('#modal-message').hide();}
return this.ele.modal({show:true,backdrop:'static',keyboard:this.keyboard});};Modal.prototype.addListener=function(event,listener){return this.listeners[event]=listener;};Modal.prototype.setListeners=function(listeners1,autoDismiss1){var modal,primary;this.listeners=listeners1;this.autoDismiss=autoDismiss1!=null?autoDismiss1:true;modal=this;primary=this.ele.find('.primary');if(this.listeners.onPrimary){return primary.off('click').on('click',function(){if(modal.listeners.onBeforePrimary){if(modal.listeners.onBeforePrimary(modal)){return;}}
modal.listeners.onPrimary(modal);if(modal.autoDismiss){return modal.dismiss();}});}else{if(modal.autoDismiss){return primary.on('click',function(){return modal.dismiss();});}}};Modal.prototype.setMessage=function(message1){this.message=message1;};Modal.prototype.dismiss=function(){this.ele.modal('hide');return this.ele.remove();};Modal.prototype.addClass=function(className){return this.ele.addClass(className);};Modal.prototype.focusFirstInput=function(){return this.ele.find("input,textarea").filter(':first').focus();};return Modal;})();this.ConfirmationModal=(function(superClass){extend(ConfirmationModal,superClass);function ConfirmationModal(title,message){var modal,secondary;ConfirmationModal.__super__.constructor.call(this,title,message);modal=this;secondary=this.ele.find('.secondary');secondary.on('click',function(){return modal.dismiss();});secondary.show();}
ConfirmationModal.prototype.hideSecondaryButton=function(){return this.ele.find('.secondary').hide();};ConfirmationModal.prototype.setForm=function(form){return this.ele.find('.modal-body .form').append(form);};ConfirmationModal.prototype.getForm=function(){return this.ele.find('.modal-body .form').children(0);};ConfirmationModal.prototype.show=function(){ConfirmationModal.__super__.show.call(this);return this.focusFirstInput();};ConfirmationModal.prototype.setListeners=function(listeners,autoDismiss){var modal,secondary;if(autoDismiss==null){autoDismiss=true;}
ConfirmationModal.__super__.setListeners.call(this,listeners,autoDismiss);modal=this;if(modal.listeners.onSecondary){secondary=this.ele.find('.secondary');return secondary.on('click',function(){return modal.listeners.onSecondary(modal);});}};return ConfirmationModal;})(this.Modal);this.Modax=(function(superClass){extend(Modax,superClass);function Modax(title,url1){var modal;this.url=url1;Modax.__super__.constructor.call(this,title,null);modal=this;this.ele.find('.primary').on('click',function(){return modal.submit();});}
Modax.prototype.setRedirectOnSuccess=function(redirectOnSuccess){this.redirectOnSuccess=redirectOnSuccess;};Modax.prototype.setListeners=function(listeners,autoDismiss){if(autoDismiss==null){autoDismiss=false;}
return Modax.__super__.setListeners.call(this,listeners,autoDismiss);};Modax.prototype.show=function(){var modal;Modax.__super__.show.call(this);this.ele.find('.loader').show();modal=this;modal.submitText=modal.ele.find('.primary').text();return fetchPJAXContent(this.url,"#active-modal .fetched-content",{onSuccess:function(){var submitText;modal.ele.find('.loader').hide();submitText=$(".form-group button[type='submit']").text();if(submitText){modal.submitText=submitText;}
modal.ele.find(".primary").text(modal.submitText);modal.focusFirstInput();if(modal.listeners&&modal.listeners.onFormLoaded){modal.listeners.onFormLoaded();}
prepareOmnibox();return select2field($('.select2_field'));}});};Modax.prototype.submit=function(){var modal,postData;modal=this;modal.ele.find('.primary').text(gettext("Processing..")).addClass("disabled");postData=modal.ele.find('form').serialize();return fetchPJAXContent(this.url,'#active-modal .fetched-content',{postData:postData,shouldIgnore:function(data){var ignore;ignore=/success-script/i.test(data);return ignore;},onIgnore:function(xhr){var redirect;if(!modal.redirectOnSuccess){modal.ele.find(".primary").removeClass("disabled").text(modal.submitText);}
if(modal.listeners){if(modal.listeners.onCompleted){modal.listeners.onCompleted(xhr);}
if(modal.listeners.onSuccess){modal.listeners.onSuccess(xhr);}}
if(modal.redirectOnSuccess){modal.ele.find('.fetched-content').hide();modal.ele.find('.loader').show();redirect=xhr.getResponseHeader("Temba-Success");if(redirect){return document.location.href=redirect;}else{return modal.dismiss();}}else{return modal.dismiss();}},onSuccess:function(){modal.ele.find(".primary").removeClass("disabled").text(modal.submitText);if(modal.listeners&&modal.listeners.onCompleted){return modal.listeners.onCompleted();}else{return modal.focusFirstInput();}}});};return Modax;})(this.ConfirmationModal);$(function(){return $('.uv-send-message').click(function(){return UserVoice.push(['show',{}]);});});}).call(this);(function(){var _bindToggle,_initializeForm,_submitFormax,hideSection,showSection;showSection=function(section){var ie;ie=section.parents("html").hasClass("ie");if(section.data("readonly")){return;}
if(ie||section.data("action")==='fixed'){section.find(".formax-form").show();section.find(".formax-icon").css({"font-size":"80px",width:"80px",height:"80px"});}else{section.find(".formax-icon").animate({"font-size":"80px",width:"80px",height:"80px"},100);section.find(".formax-form").slideDown("fast",function(){return section.find("input[type=text]:first").focus();});}
return section.find(".formax-summary").hide();};hideSection=function(section){var ie;if(section.data("action")==='fixed'){return;}
ie=section.parents("html").hasClass("ie");if(ie){section.find(".formax-summary").show();return section.find(".formax-form").hide();}else{section.find(".formax-icon").animate({"font-size":"35px",width:"40px",height:"40px"},100);section.find(".formax-summary").fadeIn("slow");return section.find(".formax-form").hide();}};window.fetchData=function(section){var url;if(section.data("href")){url=section.data('href');return fetchPJAXContent(url,"#"+section.attr("id")+" > .formax-container",{headers:{"X-FORMAX":true},onSuccess:function(){section.data("loaded",true);_initializeForm(section);if(section.data("fixed")){showSection(section);}else{_bindToggle(section.find(".formax-icon"));}
return section.show();}});}else{return section.data("loaded",true);}};_initializeForm=function(section){var action,buttonName,form,onLoad;action=section.data('action');form=section.find("form");if(action==='formax'||action==='redirect'||action==='open'){buttonName=section.data("button");if(!buttonName){buttonName=gettext("Save");}
form.off("submit").on("submit",_submitFormax);if(!section.data("nobutton")){form.append("<input type=\"submit\" class=\"btn btn-primary submit-button\" value=\""+buttonName+"\"/>");form.find(".form-actions").remove();}
form.find(".submit-button").on("click",function(){return $(this).addClass("disabled").attr("enabled",false);});onLoad=section.data("onload");if(onLoad){eval_(onLoad)();}
if(!section.data("fixed")){_bindToggle(section.find(".formax-summary"));}
if(action==='open'){showSection(section);window.scrollTo(0,section.offset().top);}}
if(action==='fixed'){return form.attr("action",section.data("href"));}};_submitFormax=function(e){var followRedirects,form,section;e.preventDefault();form=$(this);section=form.parents("li");followRedirects=section.data("action")==='redirect';return fetchPJAXContent(section.data("href"),"#"+section.attr("id")+" > .formax-container",{postData:form.serialize(),headers:{"X-FORMAX":true},followRedirects:followRedirects,onSuccess:function(){var dependents,formax_form;_initializeForm(section);formax_form=section.find(".formax-form");if(formax_form.hasClass("errors")){section.find(".formax-summary").hide();formax_form.show();}else{if(section.data("action")!=='fixed'){hideSection(section);}}
dependents=section.data("dependents");if(dependents){return $("#id-"+dependents).each(function(){return fetchData($(this));});}}});};_bindToggle=function(bindTo){var action,section;section=bindTo.parents("li");action=section.data('action');if(action==='fixed'){return showSection(section);}else if(action==='formax'||action==='redirect'||action==='open'){return bindTo.off("click").on("click",function(){section=$(this);if(!bindTo.tagName!=="formax"){section=bindTo.parents("li");}
$("ul.formax > li").each(function(){if($(this).attr("id")!==section.attr("id")){return hideSection($(this));}});if(section.find(".formax-form").is(":visible")){return hideSection(section);}else{return showSection(section);}});}else if(action==='link'){return bindTo.off("click").on("click",function(){return document.location.href=section.data('href');});}};$(function(){$('li .formax-summary').each(function(){var section;section=$(this);return _bindToggle(section);});$('.formax li').each(function(){var section;section=$(this);return _initializeForm(section);});return $('li .formax-icon').each(function(){var section;section=$(this);return _bindToggle(section);});});}).call(this);(function(){window.AutoComplete=(function(){var KEY_LEFT,KEY_RIGHT;KEY_LEFT=37;KEY_RIGHT=39;function AutoComplete(variables1,functions){var ac,f,i,len,ref;this.variables=variables1!=null?variables1:[];this.functions=functions!=null?functions:[];this.parser=new window.excellent.Parser('@',['channel','contact','date','extra','flow','step','parent','child','new_contact']);this.completions=this.variables.concat(this.functions);this.invalidFields={};ref=this.functions;for(i=0,len=ref.length;i<len;i++){f=ref[i];f['function']=true;f['example']=f['signature'];}
ac=this;this.config={at:"@",insertBackPos:1,data:this.variables,searchKey:"name",insertTpl:this.getInsertTemplate,startWithSpace:true,displayTpl:this.getDisplayTemplate,limit:100,maxLen:100,suffix:"",callbacks:{highlighter:function(li,query){return li;},matcher:function(flag,subtext){return ac.parser.expressionContext(subtext);},filter:function(query,data,searchKey){var lastIdx,results,start,subQuery;if(query&&query[0]==='('){data=ac.completions;}
subQuery=ac.parseFilterQuery(query);lastIdx=subQuery?subQuery.lastIndexOf('.'):-1;start=subQuery.substring(0,lastIdx);results=ac.findCompletions(subQuery,data,start,lastIdx);return results;},sorter:function(query,items,searchKey){var item,j,lastOptFunctions,len1,results,subQuery;lastOptFunctions={'name':'(','display':"Functions",'function':true};subQuery=ac.parseQuery(query);results=[];for(j=0,len1=items.length;j<len1;j++){item=items[j];if(query){item.order=new String(item[searchKey]).toLowerCase().indexOf(subQuery.toLowerCase());if(item.order>-1){results.push(item);}}else{results.push(item);}}
if(!query||query.match(/[(.]/g)===null){results.push(lastOptFunctions);}
results.sort(function(a,b){if(a.order!==b.order){return a.order-b.order;}
if(a["function"]&&!b["function"]){return 1;}else if(b["function"]&&!a["function"]){return-1;}
if((a["function"]&&b["function"])||(!a["function"]&&!b["function"])){if(a.name>b.name){return 1;}else{return-1;}}});return results;},tplEval:function(tpl,map,action){var error,query,subQuery,template;template=tpl;query=this.query.text;subQuery=ac.parseQuery(query);try{template=tpl(map,query,subQuery);return template.replace(/\$\{([^\}]*)\}/g,function(tag,key,pos){return map[key];});}catch(error1){error=error1;return"";}},beforeInsert:function(value,item){var completionChars,hasMore,isFunction,j,k,len1,len2,match,option,ref1,ref2,valueForName;completionChars=new RegExp("([A-Za-z_\\d\.]*)$",'gi');valueForName="";match=completionChars.exec(value);if(match){valueForName=match[2]||match[1];}
hasMore=false;ref1=ac.variables;for(j=0,len1=ref1.length;j<len1;j++){option=ref1[j];hasMore=valueForName&&option.name.indexOf(valueForName+'.')===0&&option.name!==valueForName;if(hasMore){break;}}
if(hasMore){value+='.';}
isFunction=false;ref2=ac.functions;for(k=0,len2=ref2.length;k<len2;k++){option=ref2[k];isFunction=valueForName&&option.name.indexOf(valueForName)===0&&option.name===valueForName;if(isFunction){break;}}
if(isFunction){value+='()';}
if(valueForName===""&&value==='@('){value+=')';}else if(valueForName&&!hasMore&&!isFunction){value+=" ";}
return value;}}};}
AutoComplete.prototype.findInvalidFields=function(text){var field,fields,i,j,key,len,len1,re,ref,validKeys,variable;if(!text){return[];}
validKeys={"id":true,"telegram":true,"facebook":true};ref=this.variables;for(i=0,len=ref.length;i<len;i++){variable=ref[i];if(variable.name.startsWith('contact')){key=variable.name.slice(8);if(key){validKeys[key]=true;}}}
fields=this.parser.getContactFields(text);re=/[a-z][a-z0-9_]+/;for(j=0,len1=fields.length;j<len1;j++){field=fields[j];if(!(field in validKeys)||!re.exec(field)){this.invalidFields[field]=true;}}
return Object.keys(this.invalidFields);};AutoComplete.prototype.getInvalidFields=function(){return Object.keys(this.invalidFields);};AutoComplete.prototype.getDisplayTemplate=function(map,query,subQuery){var template;template="<li><div class='completion-dropdown'><div class='option-name'>${name}</div><small class='option-display'>${display}</small></div></li>";if(typeof map.example!=="undefined"){template="<li><div class='completion-dropdown'><div class='option-name'>${name}</div><div class='option-example'><div class='display-labels'>Example</div>${example}</div><div class='option-display'><div class='display-labels'>Summary</div>${display}</div></div></li>";}
return template;};AutoComplete.prototype.getInsertTemplate=function(map,query,subQuery){var regexp,template;if(query&&query[0]==='('){if(query.length===1&&subQuery===""){template='@(${name}';}else{regexp=new RegExp("@*"+subQuery+"$");template=('@'+query).replace(regexp,'${name}');}}else{regexp=new RegExp(subQuery+"$");template=('@'+query).replace(regexp,'${name}');}
return template;};AutoComplete.prototype.parseFilterQuery=function(query){if(!query){return query;}
if(query.match(/[(]*[^"]*["]/)){if(this.parser.isInStringLiteral(query)){return null;}}
return this.parser.autoCompleteContext(query)||'';};AutoComplete.prototype.parseQuery=function(query){var parsedQuery;parsedQuery=this.parseFilterQuery(query);if(!parsedQuery){return parsedQuery;}
if(parsedQuery[0]==='#'){parsedQuery=parsedQuery.slice(1);}
return parsedQuery;};AutoComplete.prototype.findCompletions=function(query,data,start,lastIdx,prependChar){var display,i,j,justFirstResult,key,len,len1,matched,matchingOption,name,nextDot,option,ref,results,suffix;if(prependChar==null){prependChar=void 0;}
matched={};results=[];justFirstResult=false;if(query[0]==='#'){query=query.slice(1);justFirstResult=true;}
for(i=0,len=data.length;i<len;i++){option=data[i];if(option.name.toLowerCase().indexOf(query.toLowerCase())===0){nextDot=option.name.indexOf('.',lastIdx+1);if(nextDot===-1){if(prependChar){name=start+prependChar+option.name;}else{name=option.name;}
display=option.display;}else{name="";suffix=option.name.substring(lastIdx+1,nextDot);if(start.length>0&&start!==suffix){name=start+".";}
name+=suffix;if(name.toLowerCase().indexOf(query.toLowerCase())!==0){continue;}
display=null;}
if(!(name in matched)){matched[name]=name;matchingOption={name:name,display:display};ref=Object.keys(option);for(j=0,len1=ref.length;j<len1;j++){key=ref[j];if(key!=='name'&&key!=='display'){matchingOption[key]=option[key];}}
results.push(matchingOption);}}}
if(justFirstResult){return results.slice(0,1);}
return results;};AutoComplete.prototype.bind=function(selector,variables){var inputor;if(variables==null){variables=null;}
if(variables){this.completions=variables.concat(this.functions);}
inputor=$(selector).atwho(this.config);inputor.atwho('run');inputor.on('inserted.atwho',function(atEvent,li,browserEvent){var caretPos,content,subtext;content=inputor.val();caretPos=inputor.caret('pos');subtext=content.slice(0,caretPos);if(subtext.match(/\(\)$/)!==null){return inputor.caret('pos',subtext.length-1);}});inputor.off('click.atwhoInner').on('click.atwhoInner',function(e){return inputor.atwho('hide');});return inputor.off('keyup.atwhoInner').on('keyup.atwhoInner',function(e){var app,atwho,caretPos,content,nextPart,ref,subtext,text,view;atwho=inputor.data('atwho');if(atwho){app=atwho.setContextFor('@');view=(ref=app.controller())!=null?ref.view:void 0;switch(e.keyCode){case KEY_LEFT:case KEY_RIGHT:if(view.visible()){app.dispatch(e);}
return;default:app.onKeyup(e);}
content=inputor.val();caretPos=inputor.caret('pos');subtext=content.slice(0,caretPos);nextPart=content.slice(caretPos);if(subtext.slice(-2)==='@('&&(!nextPart||nextPart.slice(0,1)===!')')){text=subtext+')'+content.slice(caretPos+1);inputor.val(text);return inputor.caret('pos',caretPos);}}});};return AutoComplete;})();}).call(this);