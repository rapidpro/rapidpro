# Generated by Django 5.1.2 on 2024-10-30 21:23

from django.db import migrations, transaction
from django.db.models import Count


def backfill_item_counts(apps, schema_editor):  # pragma: no cover
    Org = apps.get_model("orgs", "Org")

    for org in Org.objects.all():
        for topic in org.topics.all():
            with transaction.atomic():
                counts = topic.tickets.values("status", "assignee_id").annotate(count=Count("*"))
                for count in counts:
                    status = count["status"]
                    assignee_id = count["assignee_id"]
                    scope = f"tickets:{status}:{topic.id}:{assignee_id or 0}"
                    org.counts.filter(scope=scope).delete()
                    org.counts.create(scope=scope, count=count["count"], is_squashed=True)


class Migration(migrations.Migration):

    atomic = False

    dependencies = [("tickets", "0070_update_triggers")]

    operations = [migrations.RunPython(backfill_item_counts, migrations.RunPython.noop)]
