# Generated by Django 4.0.7 on 2022-11-11 18:26

from django.db import migrations


def flatten_flow_labels(apps, schema_editor):  # pragma: no cover
    FlowLabel = apps.get_model("flows", "FlowLabel")

    # We display parent labels as the set of flows they're assigned to plus the flows their children are assigned to so
    # now we explicitly assign those flows to the parents.
    for label in FlowLabel.objects.exclude(children=None):
        num_children = 0

        for child in label.children.all():
            label.flows.add(*child.flows.all())

            child.name = f"{label.name} > {child.name}"[:64]
            child.save(update_fields=("name",))
            num_children += 1

        if num_children:
            print(f"Flattened flow label {label.name} with {num_children} children")

    # and remove the parent-child relationsips
    for label in FlowLabel.objects.exclude(children=None):
        label.children.clear()


def reverse(apps, schema_editor):  # pragma: no cover
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("flows", "0301_exportflowresultstask_with_groups"),
    ]

    operations = [migrations.RunPython(flatten_flow_labels, reverse)]
