# Generated by Django 5.1.2 on 2024-11-28 18:05

from django.db import migrations

SQL = """
----------------------------------------------------------------------
-- Handles changes relating to a flow run's path
----------------------------------------------------------------------
CREATE OR REPLACE FUNCTION temba_flowrun_path_change() RETURNS TRIGGER AS $$
BEGIN
    -- we don't support rewinding run paths, so the new path must be longer than the old
    IF jsonb_array_length(COALESCE(NEW.path, '[]')::jsonb) < jsonb_array_length(COALESCE(OLD.path, '[]')::jsonb) THEN
        RAISE EXCEPTION 'Cannot rewind a flow run path';
    END IF;

  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER temba_flowrun_insert ON flows_flowrun;
DROP FUNCTION temba_flowrun_insert();
DROP FUNCTION temba_insert_flowpathcount(INTEGER, UUID, UUID, TIMESTAMP WITH TIME ZONE, INTEGER);
"""


class Migration(migrations.Migration):

    dependencies = [("flows", "0345_backfill_segment_counts")]

    operations = [migrations.RunSQL(SQL)]
