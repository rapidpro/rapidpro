# Generated by Django 4.0.7 on 2022-11-15 20:50

from django.db import migrations


def flatten_labels(apps, schema_editor):  # pragma: no cover
    Label = apps.get_model("msgs", "Label")

    for label in Label.objects.filter(is_active=True).exclude(folder=None).select_related("folder"):
        old_name = label.name
        label.name = f"{label.folder.name} > {label.name}"[:64]
        label.folder = None
        label.save(update_fields=("name", "folder"))

        print(f"Flattened label #{label.id} '{old_name}' to '{label.name}'")

    for folder in Label.objects.filter(is_active=True, label_type="F"):
        folder.counts.all().delete()
        folder.exportmessagestask_set.all().delete()
        folder.delete()
        print(f"Deleted folder #{folder.id} '{folder.name}'")


def reverse(apps, schema_editor):  # pragma: no cover
    pass


class Migration(migrations.Migration):

    dependencies = [("msgs", "0200_remove_msg_topup")]

    operations = [migrations.RunPython(flatten_labels, reverse)]
