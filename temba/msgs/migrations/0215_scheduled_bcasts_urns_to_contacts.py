# Generated by Django 4.0.9 on 2023-02-10 14:27

from django.db import migrations

from temba.utils import chunk_list


def convert_urns_to_contacts(apps, schema_editor):  # pragma: no cover
    Broadcast = apps.get_model("msgs", "Broadcast")

    # find non-deleted scheduled broadcasts with urns
    broadcasts = list(
        Broadcast.objects.filter(is_active=True)
        .exclude(schedule=None)
        .exclude(urns=None)
        .only("id")
        .prefetch_related("urns")
    )

    num_updated = 0

    for batch in chunk_list(broadcasts, 100):
        for bcast in batch:
            for urn in bcast.urns.all():
                if urn.contact_id:
                    bcast.contacts.add(urn.contact_id)

            bcast.urns.clear()
            num_updated += 1

        print(f"Updated {num_updated} of {len(broadcasts)} scheduled broadcasts with URNs")


def reverse(apps, schema_editor):  # pragma: no cover
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("msgs", "0214_broadcast_query_msg_quick_replies"),
    ]

    operations = [migrations.RunPython(convert_urns_to_contacts, reverse)]
